# .github/workflows/codex-commit.yml
name: Codex Commit (Explicit)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  commit:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/codex commit')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          persist-credentials: true

      - name: Run Codex (fix)
        uses: openai/codex-action@v1
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY_CI }}
          task: fix

      - name: Guard (safety checks)
        run: |
          ./scripts/codex_guard.sh

      - name: Commit & Push
        run: |
          git config user.name "codex-bot"
          git config user.email "codex@users.noreply.github.com"
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            git commit -am "codex: explicit fix"
            git push
          fi
